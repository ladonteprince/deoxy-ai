<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Pipeline â€” Deoxy.ai Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/admin/css/admin.css">
  <style>
    .blog-cards { display: flex; flex-direction: column; gap: 12px; }

    .blog-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 24px;
      transition: all var(--transition);
    }
    .blog-card:hover { border-color: var(--border-hover); }

    .blog-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 10px;
    }
    .blog-card-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text);
      line-height: 1.4;
    }
    .blog-card-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 14px;
    }
    .blog-card-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .blog-card-actions .status-select {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 10px;
      color: var(--text);
      font-family: var(--font);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 100px;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      flex-shrink: 0;
    }
    .status-draft { background: rgba(108, 92, 231, 0.15); color: var(--accent-light); }
    .status-review { background: rgba(0, 206, 201, 0.15); color: var(--cyan); }
    .status-published { background: rgba(0, 184, 148, 0.15); color: var(--success); }

    .editor-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .editor-pane {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .editor-pane-label {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }
    .editor-preview {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 20px;
      min-height: 300px;
      max-height: 400px;
      overflow-y: auto;
    }

    @media (max-width: 900px) {
      .editor-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <button class="admin-sidebar-toggle" aria-label="Menu"><span></span><span></span><span></span></button>
  <div class="admin-sidebar-overlay"></div>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-logo">
        <span class="logo-mark">&#9672;</span>
        <span class="logo-text">deoxy<span class="logo-accent">.ai</span></span>
        <span class="admin-label">ADMIN</span>
      </div>
      <nav class="sidebar-nav">
        <a href="/admin" class="nav-item"><span class="nav-icon">&#9632;</span> Dashboard</a>
        <a href="/admin/research" class="nav-item"><span class="nav-icon">&#9830;</span> Research Library</a>
        <a href="/admin/briefs" class="nav-item"><span class="nav-icon">&#9827;</span> Evidence Briefs</a>
        <a href="/admin/companies" class="nav-item"><span class="nav-icon">&#9829;</span> Companies</a>
        <a href="/admin/pipeline" class="nav-item active"><span class="nav-icon">&#9824;</span> Content Pipeline</a>
        <a href="/admin/subscribers" class="nav-item"><span class="nav-icon">&#9733;</span> Subscribers</a>
        <a href="/admin/insights" class="nav-item"><span class="nav-icon">&#10024;</span> Insight Generator</a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" target="_blank" class="sidebar-link">View Site &rarr;</a>
        <button id="logoutBtn" class="sidebar-link">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <header class="admin-header">
        <div>
          <h1>Content Pipeline</h1>
          <p id="blogCount">Loading blog posts...</p>
        </div>
        <div class="admin-header-actions">
          <button class="admin-btn admin-btn-primary" onclick="openGenerateModal()">
            + Generate Blog
          </button>
        </div>
      </header>

      <!-- Status Filter Tabs -->
      <div class="admin-tabs" id="statusTabs">
        <button class="admin-tab active" data-status="">All</button>
        <button class="admin-tab" data-status="draft">Drafts</button>
        <button class="admin-tab" data-status="review">In Review</button>
        <button class="admin-tab" data-status="published">Published</button>
      </div>

      <!-- Blog Cards -->
      <div class="blog-cards" id="blogCards">
        <div style="text-align:center; padding:60px 24px; color:var(--text-muted);">Loading...</div>
      </div>
    </main>
  </div>

  <!-- Edit Blog Modal -->
  <div class="admin-modal admin-modal-lg" id="editBlogModal">
    <div class="admin-modal-content" style="max-width:900px;">
      <div class="admin-modal-header">
        <h2 id="editBlogTitle">Edit Blog</h2>
        <button class="admin-btn admin-btn-ghost admin-btn-icon" onclick="closeModal('editBlogModal')">&times;</button>
      </div>
      <div class="admin-modal-body">
        <input type="hidden" id="editBlogId">

        <div class="admin-form-group">
          <label>Title</label>
          <input type="text" id="editBlogTitleInput" class="admin-input" placeholder="Blog title">
        </div>

        <div class="admin-form-group">
          <label>Status</label>
          <select id="editBlogStatus" class="admin-select" style="max-width:200px;">
            <option value="draft">Draft</option>
            <option value="review">In Review</option>
            <option value="published">Published</option>
          </select>
        </div>

        <div class="editor-layout">
          <div class="editor-pane">
            <span class="editor-pane-label">Markdown Editor</span>
            <textarea id="editBlogBody" class="admin-textarea" style="min-height:300px; font-family:var(--mono); font-size:0.8125rem; line-height:1.7; resize:vertical;" placeholder="Write your blog post in markdown..."></textarea>
          </div>
          <div class="editor-pane">
            <span class="editor-pane-label">Preview</span>
            <div id="editBlogPreview" class="editor-preview admin-markdown"></div>
          </div>
        </div>
      </div>
      <div class="admin-modal-footer">
        <button class="admin-btn" onclick="closeModal('editBlogModal')">Cancel</button>
        <button class="admin-btn admin-btn-primary" id="saveBlogBtn" onclick="saveBlog()">Save</button>
      </div>
    </div>
  </div>

  <!-- Generate Blog Modal -->
  <div class="admin-modal" id="generateBlogModal">
    <div class="admin-modal-content" style="max-width:500px;">
      <div class="admin-modal-header">
        <h2>Generate Blog from Paper</h2>
        <button class="admin-btn admin-btn-ghost admin-btn-icon" onclick="closeModal('generateBlogModal')">&times;</button>
      </div>
      <div class="admin-modal-body">
        <div class="admin-form-group">
          <label>Select a Research Paper</label>
          <select id="generatePaperSelect" class="admin-select">
            <option value="">Choose a paper...</option>
          </select>
        </div>
        <div id="generateResult" style="display:none; margin-top:16px; padding:16px; background:rgba(0,184,148,0.08); border:1px solid rgba(0,184,148,0.2); border-radius:var(--radius-sm);">
          <p style="color:var(--success); font-weight:600; font-size:0.875rem;" id="generateResultText"></p>
        </div>
      </div>
      <div class="admin-modal-footer">
        <button class="admin-btn" onclick="closeModal('generateBlogModal')">Close</button>
        <button class="admin-btn admin-btn-primary" id="generateBtn" onclick="generateBlog()">Generate</button>
      </div>
    </div>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    let blogs = [];
    let currentStatusFilter = '';

    // ---- Load Blogs ----
    async function loadBlogs() {
      try {
        const params = currentStatusFilter ? `?status=${currentStatusFilter}` : '';
        const data = await api(`/blogs${params}`);
        blogs = Array.isArray(data) ? data : (data.blogs || data);
        const countText = blogs.length === 1 ? '1 blog post' : `${blogs.length} blog posts`;
        document.getElementById('blogCount').textContent = countText;
        renderBlogs();
      } catch (err) {
        document.getElementById('blogCards').innerHTML =
          '<div style="text-align:center; padding:60px 24px; color:var(--danger);">Failed to load blog posts.</div>';
      }
    }

    // ---- Render Blog Cards ----
    function renderBlogs() {
      const container = document.getElementById('blogCards');
      if (blogs.length === 0) {
        container.innerHTML = `
          <div style="text-align:center; padding:60px 24px; color:var(--text-muted);">
            <div style="font-size:2rem; margin-bottom:12px; opacity:0.4;">&#9824;</div>
            <p>No blog posts found. Generate one from a research paper.</p>
          </div>`;
        return;
      }

      container.innerHTML = blogs.map(b => {
        const statusClass = b.status === 'draft' ? 'status-draft' : b.status === 'review' ? 'status-review' : 'status-published';
        const statusLabel = b.status === 'review' ? 'In Review' : b.status.charAt(0).toUpperCase() + b.status.slice(1);
        const wordCount = b.body ? b.body.split(/\s+/).filter(Boolean).length : 0;

        return `
          <div class="blog-card" data-id="${b.id}">
            <div class="blog-card-header">
              <div class="blog-card-title">${escapeHtml(b.title)}</div>
              <span class="status-badge ${statusClass}">${statusLabel}</span>
            </div>
            <div class="blog-card-meta">
              ${b.paper_title ? `<span title="Related paper">&#9830; ${escapeHtml(truncate(b.paper_title, 50))}</span>` : ''}
              <span>${fmtDate(b.created_at)}</span>
              <span style="font-family:var(--mono);">${wordCount.toLocaleString()} words</span>
            </div>
            <div class="blog-card-actions">
              <button class="admin-btn admin-btn-sm" onclick="openEditBlog(${b.id})">Edit</button>
              <select class="status-select" onchange="changeStatus(${b.id}, this.value)">
                <option value="" disabled selected>Change Status</option>
                <option value="draft">Draft</option>
                <option value="review">In Review</option>
                <option value="published">Published</option>
              </select>
              <div style="flex:1;"></div>
              <button class="admin-btn admin-btn-sm admin-btn-danger" onclick="deleteBlog(${b.id})">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ---- Status Filter Tabs ----
    document.getElementById('statusTabs').addEventListener('click', (e) => {
      const tab = e.target.closest('.admin-tab');
      if (!tab) return;
      document.querySelectorAll('#statusTabs .admin-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentStatusFilter = tab.dataset.status || '';
      loadBlogs();
    });

    // ---- Change Status ----
    async function changeStatus(id, status) {
      if (!status) return;
      const blog = blogs.find(b => b.id === id);
      if (!blog) return;

      try {
        await api(`/blogs/${id}`, {
          method: 'PUT',
          body: { title: blog.title, body: blog.body, status },
        });
        showToast(`Status changed to ${status}.`, 'success');
        loadBlogs();
      } catch (err) {
        showToast('Failed to change status.', 'error');
      }
    }

    // ---- Edit Blog ----
    function openEditBlog(id) {
      const blog = blogs.find(b => b.id === id);
      if (!blog) return;

      document.getElementById('editBlogId').value = blog.id;
      document.getElementById('editBlogTitleInput').value = blog.title || '';
      document.getElementById('editBlogBody').value = blog.body || '';
      document.getElementById('editBlogStatus').value = blog.status || 'draft';
      document.getElementById('editBlogTitle').textContent = 'Edit Blog';

      // Render preview
      updatePreview();

      openModal('editBlogModal');
    }

    // Live preview update
    document.getElementById('editBlogBody').addEventListener('input', debounce(updatePreview, 200));

    function updatePreview() {
      const md = document.getElementById('editBlogBody').value;
      document.getElementById('editBlogPreview').innerHTML = renderMarkdown(md) || '<p style="color:var(--text-muted);">Preview will appear here as you type...</p>';
    }

    async function saveBlog() {
      const id = document.getElementById('editBlogId').value;
      const title = document.getElementById('editBlogTitleInput').value.trim();
      const body = document.getElementById('editBlogBody').value;
      const status = document.getElementById('editBlogStatus').value;

      if (!title) {
        showToast('Title is required.', 'error');
        return;
      }

      const btn = document.getElementById('saveBlogBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        await api(`/blogs/${id}`, {
          method: 'PUT',
          body: { title, body, status },
        });
        showToast('Blog saved.', 'success');
        closeModal('editBlogModal');
        loadBlogs();
      } catch (err) {
        showToast('Failed to save blog.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save';
      }
    }

    // ---- Delete Blog ----
    async function deleteBlog(id) {
      if (!confirm('Are you sure you want to delete this blog post?')) return;

      try {
        await api(`/blogs/${id}`, { method: 'DELETE' });
        showToast('Blog deleted.', 'success');
        loadBlogs();
      } catch (err) {
        showToast('Failed to delete blog.', 'error');
      }
    }

    // ---- Generate Blog ----
    async function openGenerateModal() {
      document.getElementById('generateResult').style.display = 'none';
      const btn = document.getElementById('generateBtn');
      btn.disabled = false;
      btn.textContent = 'Generate';

      // Load papers for the dropdown
      try {
        const data = await api('/research?limit=500');
        const papers = data.papers || [];
        const select = document.getElementById('generatePaperSelect');
        select.innerHTML = '<option value="">Choose a paper...</option>' +
          papers.map(p => `<option value="${p.id}">${escapeHtml(p.title)}</option>`).join('');
      } catch (err) {
        showToast('Failed to load papers.', 'error');
      }

      openModal('generateBlogModal');
    }

    async function generateBlog() {
      const paperId = document.getElementById('generatePaperSelect').value;
      if (!paperId) {
        showToast('Please select a paper first.', 'error');
        return;
      }

      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="admin-loading-spinner" style="width:16px; height:16px; border-width:2px; display:inline-block;"></span> Generating...';

      try {
        const data = await api(`/blogs/generate/${paperId}`, { method: 'POST' });
        document.getElementById('generateResult').style.display = 'block';
        document.getElementById('generateResultText').textContent = `Blog generated: "${data.title}"`;
        showToast('Blog generated successfully!', 'success');
        loadBlogs();
      } catch (err) {
        showToast(err.message || 'Failed to generate blog.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Generate';
      }
    }

    // ---- Helpers ----
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ---- Init ----
    loadBlogs();
  </script>
</body>
</html>
